<!DOCTYPE html>
<head>
    <title>Painting Car</title>
    <meta charset="utf-8">
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
</head>

<body>
    <title>Robot WIFI</title>

    <div class='row d-flex p-3 bg-primary' style='color: white;'>
        <div class="col p-2">
            <i class='fas fa-robot'></i>
            <span>Painting Kart</span>
            <i class="fas fa-car"></i>
        </div>
        <div class="col text-end" id="userData" style="display: none;">
            <span>Nombre de usuario:</span>
            <span id="usernameText">u</span>
            <button class="btn btn-danger" onclick="logoff()" id="logoff">Cerrar sesión</button>
        </div>
        
        
    </div>

    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css' integrity='sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65' crossorigin='anonymous'>
    <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.15.4/css/all.css' integrity='sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm' crossorigin='anonymous'/>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'>
    
    <script>
        var ip = "";
        var xhttp = new XMLHttpRequest();
        var db;

        const alertCard = document.getElementById("alert");
        
        const session = new Date(localStorage.getItem("session"));
        
        /*

        /////////////////////////
        Incializacion de usuarios
        /////////////////////////

        localStorage.setItem("users", JSON.stringify([
        {
            "username":"admin",
        }
        ,{
            "username":"alexander",
        }
        ,{
            "username":"pepito",
        }
        ]))*/
        


        if(session){
            
            if((new Date() - session) / 1000 / 60 / 60 < 1){
                window.onload = function(){
                    Ingresar(true);
                }
                
            }
                
        }
        
        function login(){

            const users = JSON.parse(localStorage.getItem("users"));

            const username = document.getElementById("username").value
                flag = true;
                for (let i = 0; i < users.length; i++) {
                    if(users[i].username == username){
                        
                        flag = false;
                        localStorage.setItem("session", new Date().toUTCString())
                        localStorage.setItem("sessionName", username)
                        MostrarMensajeLogin("");
                        Ingresar(true);
                    }
                }

                if(flag){
                    MostrarMensajeLogin("Nombre de usuario incorrecto");
                }
            
        }

        function MostrarMensajeLogin(text){
            if(text == ""){
                $("#alert").hide();
            }else{
                $("#alert").contents().filter(function(){ return this.nodeType == 3; }).first().replaceWith(text)
                $("#alert").show();
            }
            
        }

        function Ingresar(x){
            if(x){
                $("#login").hide("slow");
                $("#app").show("slow");
                $("#userData").show();
                $("#ip1").val(localStorage.getItem("ip1"))
                $("#ip2").val(localStorage.getItem("ip2"))
                $("#ip3").val(localStorage.getItem("ip3"))
                $("#usernameText").text(localStorage.getItem("sessionName"))

            }else{
                $("#app").hide("slow");
                $("#login").show("slow");
                $("#userData").hide();
            }
        }

        const args = {
            //Comandos
            forward:'forward',
            stop:'stop',
            rightturn:'rightturn',
            leftturn:'leftturn',
            reverse:'reverse'

        }
        function getsend(arg) {
            //Enviar comando
             xhttp.open('GET', "http://" + $("#ip3").val() + "/" + arg +'?' + new Date().getTime(), true); 
             xhttp.send(); 
        }

        function logoff(){
            localStorage.removeItem("session");
            Ingresar(false);
        }

        function ip1Change(){
            localStorage.setItem("ip1", $("#ip1").val())
            $("#vid1").attr("src", "http://" + localStorage.getItem("ip1"))
        }

        function ip2Change(){
            localStorage.setItem("ip2", $("#ip2").val())
            $("#vid2").attr("src", "http://" + localStorage.getItem("ip2"))
        }

        function ip3Change(){
            localStorage.setItem("ip3", $("#ip3").val())
        }
        
        
    </script>
    <div class="container p-3 show" id="login">
        <div class="row">
            <div class="col-md-4 mx-auto">
                <div class="card card-body">
                        <div class="alert alert-warning alert-dismissible fade show" role="alert" id="alert" style="display: none;">
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
    
                        <div class="form-group p-2">
                            <p>Nombre de usuario:</p>
                            <input class="form-control" type="text" name="username" id="username" value="" placeholder="Ingrese su usuario aquí">
                        </div>
    
                        <div class="form-group p-2">
                            <button class="btn btn-success col-12" id="login" onclick="login();">Log In</button>
                        </div>
                </div>
            </div>
        </div>
    </div>

    <div class='container p-3' id="app" style="display: none;">
    <div class="row d-flex justify-content-center">
        <div class="col-sm-12 col-md-6 text-center">
            Cámara en robot móvil
            <IMG id="vid1" SRC='' onerror="this.src='./img/videoperdido.png';" style='width:100%; transform:rotate(0deg)' alt="">
                <div class="row d-flex justify-content-center p-3">
                    <div class="col-auto">
                        <label for="ip1">IP:</label>
                    </div>
                    <div class="col-auto">
                        <input type="text" class="form-control" name="ip1" id="ip1" oninput="ip1Change()">
                    </div>
                </div>
                <div class='row d-flex justify-content-center'>
                    <button class='col-auto btn btn-large btn-primary m-1' id='forward' onmouseup='getsend(args.stop)' onmousedown='getsend(args.forward)'  ontouchstart='getsend(args.forward)'>
                        <p class="p-0 m-0">Forward</p>
                        <i class="p-0 m-0 fas fa-caret-up fa-lg"></i>
                    </button> 
                </div>
            
                <div class='row d-flex justify-content-center'>
                    <button class='col-auto btn btn-large btn-primary m-1' onmousedown='getsend(args.leftturn)' onmouseup='getsend(args.stop)'  ontouchstart='getsend(args.leftturn)'>
                        <span class="p-0 m-0">&nbsp;Left&nbsp;</span> 
                        <i class="p-0 m-0 fas fa-caret-left fa-lg"></i>
                    </button>
                    <div class='col-1'>
                    </div>
                    <button id='rightTurn' class='col-auto btn btn-large btn-primary m-1' onmouseup='getsend(args.stop)' onmousedown='getsend(args.rightturn)'  ontouchstart='getsend(args.rightturn)'>
                        <i class="p-0 m-0 fas fa-caret-right fa-lg"></i>
                        <span class="p-0 m-0">Right</span>
                        
                    </button>
                </div>
            
                <div class='row d-flex justify-content-center'>
                    <button id='reverse' class='col-auto btn btn-large btn-primary m-1' onmousedown='getsend(args.reverse)' onmouseup='getsend(args.stop)' ontouchstart='getsend(args.reverse)'>
                        <i class="p-0 m-0 fas fa-caret-down fa-lg"></i>
                        <p class="p-0 m-0">Reverse</p>
                        
                    </button>
                </div>

                <div class="row d-flex justify-content-center p-3">
                    <div class="col-auto">
                        <label for="ip3">IP de control:</label>
                    </div>
                    <div class="col-auto">
                        <input type="text" class="form-control" name="ip3" id="ip3" oninput="ip3Change()">
                    </div>
                </div>
        </div>
        <div class="col-sm-12 col-md-6 text-center  p-3">
            Cámara en lienzo fija
            <IMG id="vid2" SRC='' onerror="this.src='./img/videoperdido.png';" style='width:100%;'>
                <div class="row d-flex justify-content-center p-3">
                    <div class="col-auto">
                        <label for="ip2">IP:</label>
                    </div>
                    <div class="col-auto">
                        <input type="text" class="form-control" name="ip2" id="ip2" oninput="ip2Change()">
                    </div>
                </div>
        </div>
    </div>
    <div class='row d-flex justify-content-center'>
        
        
    </div>
        

    
    </div>
    

    
    
    
</p>

</body>
