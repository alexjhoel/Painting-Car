<!DOCTYPE html>

<head>
    <title>Painting Car</title>
    <meta charset="utf-8">
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <style>
        #access{
            position:fixed;
	        width:60px;
	        height:60px;
	        bottom:40px;
	        right:40px;
	        background-color:#0C9;
	        color:#FFF;
            border: none;
	        border-radius:50px;
	        text-align:center;
	        box-shadow: 2px 2px 3px #999;
        }
    </style>
</head>

<body>
    <title>Robot WIFI</title>

    <div class='row d-flex p-3 bg-primary' style='color: white;'>
        <div class="col p-2">
            <i class='fas fa-robot'></i>
            <span>Painting Kart</span>
            <i class="fas fa-car"></i>
        </div>
        <div class="col text-end" id="userData" style="display: none;">
            <span>Nombre de usuario:</span>
            <span id="usernameText">u</span>
            <button class="btn btn-danger" onclick="logoff()" id="logoff" name="Cerrar Sesión">Cerrar sesión</button>
        </div>


    </div>

    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css'
        integrity='sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65' crossorigin='anonymous'>
    <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.15.4/css/all.css'
        integrity='sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm' crossorigin='anonymous' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'>

    <script>
        var xhttp = new XMLHttpRequest();
        var db;

        const ip1 = "";
        const ip2 = "";
        const ip3 = "";

        const alertCard = document.getElementById("alert");

        const session = new Date(localStorage.getItem("session"));

        var ttsEnabled = true;
        let synth = window.speechSynthesis;



        /////////////////////////
        //Inicializacion de usuarios
        /////////////////////////
        /*

        localStorage.setItem("users", JSON.stringify([
        {
            "username":"admin",
        }
        ,{
            "username":"alexander",
        }
        ,{
            "username":"pepito",
        }
        ]))*/

        

        if (session) {

            if ((new Date() - session) / 1000 / 60 / 60 < 1) {
                window.onload = function () {
                    
                    Ingresar(true);
                }

            }

        }

        function setSpeech() {
            //Obtener lista de voces
            return new Promise(
            function (resolve, reject) {
                let synth = window.speechSynthesis;
                let id;

                id = setInterval(() => {
                    if (synth.getVoices().length !== 0) {
                        resolve(synth.getVoices());
                        clearInterval(id);
                    }
                }, 10);
                }
            )
        }

        let s = setSpeech();
        var voicesList = null;
        s.then((voices) => {
            voicesList=voices
            console.log(voicesList)
        });

        document.body.onload = () => {
            document.querySelectorAll("button").forEach((element) => element.onmouseenter = () => textToSpeech(element.name))
            document.querySelectorAll("input").forEach((element) => element.onmouseenter = () => textToSpeech(element.name))
            document.querySelectorAll("button").forEach((element) => element.onfocus = () => textToSpeech(element.name + " ,click"))
            document.querySelectorAll("input").forEach((element) => element.onfocus = () => textToSpeech(element.name + " ,click"))
        }

        

        function login() {
            

            const users = JSON.parse(localStorage.getItem("users"));

            const username = document.getElementById("username").value
            flag = true;
            for (let i = 0; i < users.length; i++) {
                if (users[i].username == username) {

                    flag = false;
                    localStorage.setItem("session", new Date().toUTCString())
                    localStorage.setItem("sessionName", username)
                    MostrarMensajeLogin("");
                    Ingresar(true);
                }
            }

            if (flag) {
                MostrarMensajeLogin("Nombre de usuario incorrecto");
            }

        }

        function MostrarMensajeLogin(text) {
            if(text!="")textToSpeech("Aviso:" + text)
            if (text == "") {
                $("#alert").hide();
            } else {
                $("#alert").contents().filter(function () { return this.nodeType == 3; }).first().replaceWith(text)
                $("#alert").show();
            }

        }

        function Ingresar(x) {
            if (x) {
                
                $("#login").hide("slow");
                $("#app").show("slow");
                $("#userData").show();
                $("#vid1").attr("src", $("#ip1").val())
                $("#vid2").attr("src", $("#ip2").val())
                $("#usernameText").text(localStorage.getItem("sessionName"))
                textToSpeech("Has iniciado sesión como " + localStorage.getItem("sessionName"))

            } else {
                $("#app").hide("slow");
                $("#login").show("slow");
                $("#userData").hide();
            }
        }

        function textToSpeech(text){
            if(!ttsEnabled) return;
            synth.cancel();
            const voiceName = "Microsoft Sabina - Spanish (Mexico)";
            let utterance = new SpeechSynthesisUtterance(text);

            for(let voice of voicesList){
                
                if(voiceName === voice.name){
                    utterance.voice = voice;
                }
            }

            synth.speak(utterance);
        }

        

        

        const args = {
            //Comandos
            forward: 'forward',
            stop: 'stop',
            rightturn: 'rightturn',
            leftturn: 'leftturn',
            reverse: 'reverse'

        }
        function getsend(arg) {
            //Enviar comando
            xhttp.open('GET', ip3 + "/" + arg + '?' + new Date().getTime(), true);
            xhttp.send();
        }

        function logoff() {
            localStorage.removeItem("session");
            Ingresar(false);
        }

        function ttsChange(){
            ttsEnabled = !ttsEnabled
        }


    </script>
    <div class="container p-3 show" id="login">
        <div class="row">
            <div class="col-md-4 mx-auto">
                <div class="card card-body">
                    <div class="alert alert-warning alert-dismissible fade show" role="alert" id="alert"
                        style="display: none;">
                    </div>

                    <div class="form-group p-2">
                        <p>Nombre de usuario:</p>
                        <input class="form-control" type="text" name="Ingresar su usuario aquí" id="username" value=""
                            placeholder="Ingrese su usuario aquí">
                    </div>

                    <div class="form-group p-2">
                        <button class="btn btn-success col-12" id="login" onclick="login();" name="Iniciar Sesión">Log In</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class='container p-3' id="app" style="display: none;">
        <div class="row d-flex justify-content-center">
            <div class="col-sm-12 col-md-6 text-center">
                Cámara en robot móvil
                <IMG id="vid1" SRC='' onerror="this.src='./img/videoperdido.png';" style='width:100%;' alt="">
                <div class='row d-flex justify-content-center'>
                    <button class='col-auto btn btn-large btn-primary m-1' id='forward' onmouseup='getsend(args.stop)'
                        onmousedown='getsend(args.forward)' ontouchstart='getsend(args.forward)' name="Adelante">
                        <p class="p-0 m-0">Forward</p>
                        <i class="p-0 m-0 fas fa-caret-up fa-lg"></i>
                    </button>
                </div>

                <div class='row d-flex justify-content-center'>
                    <button class='col-auto btn btn-large btn-primary m-1' onmousedown='getsend(args.leftturn)'
                        onmouseup='getsend(args.stop)' ontouchstart='getsend(args.leftturn)' name="Girar a la izquierda">
                        <span class="p-0 m-0">&nbsp;Left&nbsp;</span>
                        <i class="p-0 m-0 fas fa-caret-left fa-lg"></i>
                    </button>
                    <div class='col-1'>
                    </div>
                    <button id='rightTurn' class='col-auto btn btn-large btn-primary m-1' onmouseup='getsend(args.stop)'
                        onmousedown='getsend(args.rightturn)' ontouchstart='getsend(args.rightturn)' name="Girar a la derecha">
                        <i class="p-0 m-0 fas fa-caret-right fa-lg"></i>
                        <span class="p-0 m-0">Right</span>

                    </button>
                </div>

                <div class='row d-flex justify-content-center'>
                    <button id='reverse' class='col-auto btn btn-large btn-primary m-1'
                        onmousedown='getsend(args.reverse)' onmouseup='getsend(args.stop)'
                        ontouchstart='getsend(args.reverse)' name="Reversa">
                        <i class="p-0 m-0 fas fa-caret-down fa-lg"></i>
                        <p class="p-0 m-0">Reverse</p>

                    </button>
                </div>
            </div>
            <div class="col-sm-12 col-md-6 text-center">
                Cámara en lienzo fija
                <IMG id="vid2" SRC='' onerror="this.src='./img/videoperdido.png';" style='width:100%;'>
            </div>
        </div>



    </div>





    </p>

    <button id="access" name="Desactivar texto a voz" onclick="ttsChange()"><i class="fas fa-universal-access fa-xl" style="color: #000000;" onclick="ttsChange()"></i></button>

</body>