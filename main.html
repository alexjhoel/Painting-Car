<!DOCTYPE html>

<head>
    <title>Painting Car</title>
    <meta charset="utf-8">
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <style>
        #access{
            position:fixed;
	        width:60px;
	        height:60px;
	        bottom:40px;
	        right:40px;
	        background-color:#0C9;
	        color:#FFF;
            border: none;
	        border-radius:50px;
	        text-align:center;
	        box-shadow: 2px 2px 3px #999;
        }
    </style>
</head>

<body>
    <title>Robot WIFI</title>

    <div class='row d-flex p-3 bg-primary' style='color: white;'>
        <div class="col p-2">
            <i class='fas fa-robot'></i>
            <span>Painting Kart</span>
            <i class="fas fa-car"></i>
        </div>
        <div class="col text-end" id="userData" style="display: none;">
            <span>Nombre de usuario:</span>
            <span id="usernameText">u</span>
            <button class="btn btn-danger" onclick="logoff()" id="logoff" name="Cerrar Sesión">Cerrar sesión</button>
        </div>


    </div>

    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css'
        integrity='sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65' crossorigin='anonymous'>
    <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.15.4/css/all.css'
        integrity='sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm' crossorigin='anonymous' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'>

    <script>
        var xhttp = new XMLHttpRequest();
        var db;

        const ip1 = "";
        const ip2 = "";
        const ip3 = "";

        const alertCard = document.getElementById("alert");

        const session = new Date(localStorage.getItem("session"));

        var ttsEnabled = true;
        let synth = window.speechSynthesis;



        /////////////////////////
        //Inicializacion de usuarios
        /////////////////////////
        /*

        localStorage.setItem("users", JSON.stringify([
        {
            "username":"admin",
        }
        ,{
            "username":"alexander",
        }
        ,{
            "username":"pepito",
        }
        ]))*/

        

        

        function setSpeech() {
            //Obtener lista de voces
            return new Promise(
            function (resolve, reject) {
                let synth = window.speechSynthesis;
                let id;

                id = setInterval(() => {
                    if (synth.getVoices().length !== 0) {
                        resolve(synth.getVoices());
                        clearInterval(id);
                    }
                }, 10);
                }
            )
        }

        let s = setSpeech();
        var voicesList = null;
        s.then((voices) => {
            voicesList=voices
            console.log(voicesList)
        });

        window.onload = () => {
            document.querySelectorAll("button").forEach((element) => element.onmouseenter = () => textToSpeech(element.name))
            document.querySelectorAll("input").forEach((element) => element.onmouseenter = () => textToSpeech(element.name))
            document.querySelectorAll("button").forEach((element) => element.onfocus = () => textToSpeech(element.name + " ,click"))
            document.querySelectorAll("input").forEach((element) => element.onfocus = () => textToSpeech(element.name + " ,click"))

            if (session) {

                if ((new Date() - session) / 1000 / 60 / 60 < 1) {
    
                Ingresar(true);

            }

            }
        }

        

        function login() {
            

            const users = JSON.parse(localStorage.getItem("users"));

            const username = document.getElementById("username").value
            flag = true;
            for (let i = 0; i < users.length; i++) {
                if (users[i].username == username) {

                    flag = false;
                    localStorage.setItem("session", new Date().toUTCString())
                    localStorage.setItem("sessionName", username)
                    MostrarMensajeLogin("");
                    Ingresar(true);
                }
            }

            if (flag) {
                MostrarMensajeLogin("Nombre de usuario incorrecto");
            }

        }

        function MostrarMensajeLogin(text) {
            if(text!="")textToSpeech("Aviso:" + text)
            if (text == "") {
                $("#alert").hide();
            } else {
                $("#alert").contents().filter(function () { return this.nodeType == 3; }).first().replaceWith(text)
                $("#alert").show();
            }

        }

        function Ingresar(x) {
            if (x) {
                
                $("#login").hide("slow");
                $("#app").show("slow");
                $("#userData").show();
                $("#usernameText").text(localStorage.getItem("sessionName"))
                textToSpeech("Has iniciado sesión como " + localStorage.getItem("sessionName"))

            } else {
                $("#app").hide("slow");
                $("#login").show("slow");
                $("#userData").hide();
            }
        }

        function textToSpeech(text){
            if(!ttsEnabled) return;
            synth.cancel();
            const voiceName = "Microsoft Sabina - Spanish (Mexico)";
            let utterance = new SpeechSynthesisUtterance(text);

            for(let voice of voicesList){
                
                if(voiceName === voice.name){
                    utterance.voice = voice;
                }
            }

            synth.speak(utterance);
        }
        
        const args = {
            //Comandos
            forward: '4',
            stop: '3',
            rightturn: '1',
            leftturn: '5',
            reverse: '2'

        }
        function getsend(val) {
            //Enviar comando
            fetch('http://192.168.0.101/control?var=nostop&val='+1);
            fetch('http://192.168.0.101/control?var=speed&val='+190);
            fetch('http://192.168.0.101/control?var=car&val='+val);
        }

        function logoff() {
            localStorage.removeItem("session");
            Ingresar(false);
        }

        function ttsChange(){
            ttsEnabled = !ttsEnabled
        }

        function recargarVid1(){
            $("#vid1").attr("src","http://192.168.0.102:81/stream?" + new Date().getTime())
            //$("#vid1").error = () => $("#vid1").attr("src","img/videoperdido.png")
        }

        function recargarVid2(){
            $("#vid2").attr("src","http://192.168.1.6:8080/video?" + new Date().getTime())
            //$("#vid2").error = () => $("#vid2").attr("src","img/videoperdido.png")
        }


    </script>
    <div class="container p-3 show" id="login">
        <div class="row">
            <div class="col-md-4 mx-auto">
                <div class="card card-body">
                    <div class="alert alert-warning alert-dismissible fade show" role="alert" id="alert"
                        style="display: none;">
                    </div>

                    <div class="form-group p-2">
                        <p>Nombre de usuario:</p>
                        <input class="form-control" type="text" name="Ingresar su usuario aquí" id="username" value=""
                            placeholder="Ingrese su usuario aquí">
                    </div>

                    <div class="form-group p-2">
                        <button class="btn btn-success col-12" id="login" onclick="login();" name="Iniciar Sesión">Log In</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class='container p-3' id="app" style="display: none;">
        
        <div class="row d-flex justify-content-center">
            <div class="col-sm-12 col-md-6 text-center">
                Cámara en robot móvil
                <button class="btn btn-primary" name="Recargar video robot" onclick="recargarVid1()"><svg xmlns="http://www.w3.org/2000/svg" height="0.75em" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><style>svg{fill:#ffffff}</style><path d="M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"/></svg></button>
                <IMG id="vid1" SRC=''  style='width:100%;' alt="">
                    
                <div class='row d-flex justify-content-center'>
                    <button class='col-auto btn btn-large btn-primary m-1' id='forward'
                        onmousedown='getsend(args.forward)' name="Adelante">
                        <p class="p-0 m-0">Forward</p>
                        <i class="p-0 m-0 fas fa-caret-up fa-lg"></i>
                    </button>
                </div>
                
                <div class='row d-flex justify-content-center'>
                    <button class='col-auto btn btn-large btn-primary m-1' onmousedown='getsend(args.leftturn)' name="Girar a la izquierda">
                        <span class="p-0 m-0">&nbsp;Left&nbsp;</span>
                        <i class="p-0 m-0 fas fa-caret-left fa-lg"></i>
                    </button>
                    <button id='stop' class='col-auto btn btn-large btn-primary m-1'
                        onmousedown='getsend(args.stop)' name="Parar">
                        &loz;

                    </button>
                    <button id='rightTurn' class='col-auto btn btn-large btn-primary m-1' 
                        onmousedown='getsend(args.rightturn)' name="Girar a la derecha">
                        <i class="p-0 m-0 fas fa-caret-right fa-lg"></i>
                        <span class="p-0 m-0">Right</span>

                    </button>
                </div>

                <div class='row d-flex justify-content-center'>
                    <button id='reverse' class='col-auto btn btn-large btn-primary m-1'
                        onmousedown='getsend(args.reverse)' name="Reversa">
                        <i class="p-0 m-0 fas fa-caret-down fa-lg"></i>
                        <p class="p-0 m-0">Reverse</p>

                    </button>
                </div>
            </div>
            <div class="col-sm-12 col-md-6 text-center">
                Cámara en lienzo fija 
                <button class="btn btn-primary" name="Recargar video fijo" onclick="recargarVid2()"><svg xmlns="http://www.w3.org/2000/svg" height="0.75em" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><style>svg{fill:#ffffff}</style><path d="M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"/></svg></button>
                <IMG id="vid2" src=''  style='width:100%;'>
            </div>
        </div>



    </div>





    </p>

    <button id="access" name="Desactivar texto a voz" onclick="ttsChange()"><i class="fas fa-universal-access fa-xl" style="color: #000000;"></i></button>

</body>